<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profesyonel Finans Analiz Platformu</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        :root {
            --bg: #0b0b24;
            --card: #12123a;
            --border: #252560;
            --text: #d0d0e8;
            --dim: #7777aa;
            --accent: #ffd700;
            --green: #00e070;
            --red: #ff5050;
            --blue: #4488ff;
            --purple: #b470ff;
            --orange: #ff8c00
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh
        }

        a {
            color: var(--blue);
            text-decoration: none
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px
        }

        /* HEADER */
        .app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: linear-gradient(90deg, #10103a, #1a1a50);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100
        }

        .app-header h1 {
            font-size: 1.25em;
            background: linear-gradient(90deg, #c0c0c0, #fff, #c0c0c0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: .85em
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px
        }

        .status-dot.online {
            background: var(--green);
            box-shadow: 0 0 6px var(--green)
        }

        .status-dot.offline {
            background: var(--red)
        }

        .refresh-timer {
            color: var(--dim)
        }

        #lastUpdate {
            color: var(--dim);
            font-size: .8em
        }

        /* DASHBOARD */
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            padding: 20px 0
        }

        .asset-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 18px;
            cursor: pointer;
            transition: all .2s;
            position: relative;
            overflow: hidden
        }

        .asset-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, .08)
        }

        .asset-card .icon {
            font-size: 2em;
            margin-bottom: 8px
        }

        .asset-card .name {
            font-size: 1.05em;
            font-weight: 600;
            color: #ccc;
            margin-bottom: 4px
        }

        .asset-card .price {
            font-size: 1.6em;
            font-weight: 700;
            color: var(--accent)
        }

        .asset-card .change {
            font-size: .95em;
            font-weight: 600;
            margin-top: 4px
        }

        .asset-card .change.up {
            color: var(--green)
        }

        .asset-card .change.down {
            color: var(--red)
        }

        .asset-card .unit {
            font-size: .75em;
            color: var(--dim);
            margin-top: 2px
        }

        .asset-card .mini-chart {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 120px;
            height: 50px;
            opacity: .3
        }

        .asset-card .loading-pulse {
            animation: pulse 1.5s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: .4
            }

            50% {
                opacity: 1
            }
        }

        /* DETAIL VIEW */
        #detailView {
            display: none
        }

        .detail-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap
        }

        .back-btn {
            background: rgba(100, 100, 200, .15);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 8px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: .9em;
            transition: all .2s
        }

        .back-btn:hover {
            background: rgba(100, 100, 200, .3);
            border-color: var(--blue)
        }

        .detail-title {
            font-size: 1.5em;
            font-weight: 700
        }

        .detail-price {
            font-size: 2em;
            font-weight: 700;
            color: var(--accent)
        }

        .detail-change {
            font-size: 1.1em;
            font-weight: 600;
            margin-left: 10px
        }

        .chart-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 15px;
            overflow: hidden
        }

        .chart-section h3 {
            color: var(--dim);
            font-size: .9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px
        }

        .chart-wrapper {
            position: relative;
            width: 100%
        }

        .chart-wrapper.main {
            height: 380px
        }

        .chart-wrapper.sub {
            height: 160px
        }

        .chart-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important
        }

        .chart-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px
        }

        .sub-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px
        }

        @media(max-width:900px) {
            .sub-charts {
                grid-template-columns: 1fr
            }
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px
        }

        .ind-card {
            background: rgba(30, 30, 80, .6);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            text-align: center
        }

        .ind-card .ind-label {
            font-size: .75em;
            color: var(--dim);
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .ind-card .ind-value {
            font-size: 1.15em;
            font-weight: 700;
            margin-top: 4px
        }

        .ind-card .ind-signal {
            font-size: .7em;
            font-weight: 600;
            margin-top: 4px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block
        }

        .signal-buy {
            background: rgba(0, 224, 112, .15);
            color: var(--green);
            border: 1px solid rgba(0, 224, 112, .3)
        }

        .signal-sell {
            background: rgba(255, 80, 80, .15);
            color: var(--red);
            border: 1px solid rgba(255, 80, 80, .3)
        }

        .signal-neutral {
            background: rgba(100, 100, 200, .15);
            color: var(--dim);
            border: 1px solid rgba(100, 100, 200, .3)
        }

        .levels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px
        }

        @media(max-width:800px) {
            .levels-grid {
                grid-template-columns: 1fr
            }
        }

        .level-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px
        }

        .level-card h3 {
            margin-bottom: 12px;
            padding-bottom: 8px
        }

        .level-card.buy-card h3 {
            border-bottom: 2px solid var(--green);
            color: var(--green)
        }

        .level-card.sell-card h3 {
            border-bottom: 2px solid var(--red);
            color: var(--red)
        }

        .level-table {
            width: 100%;
            border-collapse: collapse
        }

        .level-table th {
            text-align: left;
            padding: 8px;
            font-size: .8em;
            color: var(--dim);
            border-bottom: 1px solid var(--border)
        }

        .level-table td {
            padding: 8px;
            font-size: .88em;
            border-bottom: 1px solid rgba(40, 40, 100, .4)
        }

        .level-table tr:hover {
            background: rgba(100, 100, 200, .06)
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: .75em;
            font-weight: 600
        }

        .bg {
            background: rgba(0, 200, 100, .12);
            color: var(--green);
            border: 1px solid rgba(0, 200, 100, .3)
        }

        .bb {
            background: rgba(50, 120, 255, .12);
            color: var(--blue);
            border: 1px solid rgba(50, 120, 255, .3)
        }

        .by {
            background: rgba(255, 200, 0, .12);
            color: #ffc800;
            border: 1px solid rgba(255, 200, 0, .3)
        }

        .br {
            background: rgba(255, 80, 80, .12);
            color: var(--red);
            border: 1px solid rgba(255, 80, 80, .3)
        }

        .bp {
            background: rgba(180, 100, 255, .12);
            color: var(--purple);
            border: 1px solid rgba(180, 100, 255, .3)
        }

        .bo {
            background: rgba(255, 140, 0, .12);
            color: var(--orange);
            border: 1px solid rgba(255, 140, 0, .3)
        }

        .analysis-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 25px;
            margin-bottom: 15px;
            line-height: 1.8
        }

        .analysis-box h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 1.1em
        }

        .analysis-box .analyst-text {
            font-size: .92em;
            color: #b8b8d8
        }

        .analysis-box .analyst-text strong {
            color: var(--accent)
        }

        .analysis-box .verdict {
            margin-top: 15px;
            padding: 12px 18px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1em;
            display: inline-block
        }

        .verdict-buy {
            background: rgba(0, 224, 112, .1);
            color: var(--green);
            border: 1px solid rgba(0, 224, 112, .3)
        }

        .verdict-sell {
            background: rgba(255, 80, 80, .1);
            color: var(--red);
            border: 1px solid rgba(255, 80, 80, .3)
        }

        .verdict-hold {
            background: rgba(255, 215, 0, .1);
            color: var(--accent);
            border: 1px solid rgba(255, 215, 0, .3)
        }

        .fib-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px
        }

        .fib-table th {
            text-align: left;
            padding: 8px;
            font-size: .8em;
            color: var(--dim);
            border-bottom: 1px solid var(--border)
        }

        .fib-table td {
            padding: 6px 8px;
            font-size: .88em;
            border-bottom: 1px solid rgba(40, 40, 100, .3)
        }

        .disclaimer {
            background: rgba(255, 200, 0, .06);
            border: 1px solid rgba(255, 200, 0, .2);
            border-radius: 10px;
            padding: 15px;
            font-size: .8em;
            color: #aa9944;
            margin-top: 20px;
            line-height: 1.5
        }

        .loader {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
            color: var(--dim)
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin .8s linear infinite;
            margin-right: 12px
        }

        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }

        .timeframe-btns {
            display: flex;
            gap: 6px;
            margin-bottom: 10px
        }

        .tf-btn {
            background: rgba(60, 60, 120, .4);
            border: 1px solid var(--border);
            color: var(--dim);
            padding: 5px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: .82em;
            transition: all .15s
        }

        .tf-btn:hover,
        .tf-btn.active {
            background: rgba(100, 100, 200, .3);
            color: var(--text);
            border-color: var(--blue)
        }

        .refresh-btn {
            background: rgba(100, 200, 100, .15);
            border: 1px solid rgba(0, 224, 112, .3);
            color: var(--green);
            padding: 4px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: .8em;
            transition: all .15s
        }

        .refresh-btn:hover {
            background: rgba(100, 200, 100, .3)
        }

        .refresh-btn:active {
            transform: scale(0.95)
        }

        .api-log {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(10, 10, 40, 0.95);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            font-size: .75em;
            z-index: 200;
            max-width: 320px;
            line-height: 1.6;
            display: none
        }

        .api-log.visible {
            display: block
        }

        .api-ok {
            color: var(--green)
        }

        .api-fail {
            color: var(--red)
        }

        .cors-warning {
            background: linear-gradient(90deg, #4a1a00, #5a2a00);
            border: 1px solid #ff8c00;
            color: #ffcc80;
            padding: 14px 20px;
            margin: 10px 15px;
            border-radius: 10px;
            font-size: .9em;
            line-height: 1.6;
            display: none
        }

        .cors-warning.visible {
            display: block
        }

        .cors-warning strong {
            color: #ffd700
        }

        .cors-warning a {
            color: #4488ff;
            text-decoration: underline
        }

        .flash-update {
            animation: flashGreen .6s ease-out
        }

        .signal-badge-card {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 6px;
            font-size: .78em;
            font-weight: 700;
            margin-top: 6px;
            letter-spacing: .5px
        }

        .signal-badge-card.strong-buy {
            background: rgba(0, 224, 112, .15);
            color: #00e070;
            border: 1px solid rgba(0, 224, 112, .3)
        }

        .signal-badge-card.buy {
            background: rgba(0, 180, 90, .1);
            color: #00cc66;
            border: 1px solid rgba(0, 180, 90, .2)
        }

        .signal-badge-card.neutral {
            background: rgba(120, 120, 180, .1);
            color: #9999cc;
            border: 1px solid rgba(120, 120, 180, .2)
        }

        .signal-badge-card.sell {
            background: rgba(255, 80, 80, .1);
            color: #ff6666;
            border: 1px solid rgba(255, 80, 80, .2)
        }

        .signal-badge-card.strong-sell {
            background: rgba(255, 50, 50, .15);
            color: #ff5050;
            border: 1px solid rgba(255, 50, 50, .3)
        }

        .signal-summary {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 20px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            text-align: center
        }

        .signal-item {
            padding: 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, .02)
        }

        .signal-item .sig-name {
            font-size: .75em;
            color: var(--dim);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: .5px
        }

        .signal-item .sig-val {
            font-size: 1em;
            font-weight: 700
        }

        .signal-item .sig-val.buy {
            color: var(--green)
        }

        .signal-item .sig-val.sell {
            color: var(--red)
        }

        .signal-item .sig-val.neutral {
            color: var(--dim)
        }

        .overall-signal {
            grid-column: 1 / -1;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.3em;
            font-weight: 800;
            letter-spacing: 1px
        }

        .overall-signal.buy {
            background: linear-gradient(135deg, rgba(0, 224, 112, .1), rgba(0, 224, 112, .02));
            color: var(--green);
            border: 1px solid rgba(0, 224, 112, .25)
        }

        .overall-signal.sell {
            background: linear-gradient(135deg, rgba(255, 80, 80, .1), rgba(255, 80, 80, .02));
            color: var(--red);
            border: 1px solid rgba(255, 80, 80, .25)
        }

        .overall-signal.neutral {
            background: linear-gradient(135deg, rgba(120, 120, 180, .1), rgba(120, 120, 180, .02));
            color: var(--dim);
            border: 1px solid rgba(120, 120, 180, .25)
        }

        .signal-meter {
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, var(--red), var(--red) 30%, #ffc800 45%, #ffc800 55%, var(--green) 70%, var(--green));
            border-radius: 4px;
            position: relative;
            margin: 10px 0 5px
        }

        .signal-meter .meter-needle {
            position: absolute;
            top: -4px;
            width: 4px;
            height: 16px;
            background: white;
            border-radius: 2px;
            transform: translateX(-50%);
            box-shadow: 0 0 6px rgba(255, 255, 255, .5)
        }

        @keyframes flashGreen {
            0% {
                box-shadow: 0 0 15px rgba(0, 224, 112, .4);
                border-color: var(--green)
            }

            100% {
                box-shadow: none;
                border-color: var(--border)
            }
        }
    </style>
</head>

<body>

    <div class="app-header">
        <h1>ğŸ“Š FÄ°NANS ANALÄ°Z PLATFORMU</h1>
        <div class="header-right">
            <span><span class="status-dot online" id="statusDot"></span><span id="statusText">BaÄŸlÄ±</span></span>
            <button class="refresh-btn" onclick="manualRefresh()" title="Manuel GÃ¼ncelle">ğŸ”„ GÃ¼ncelle</button>
            <span class="refresh-timer" id="refreshTimer">30s</span>
            <span id="lastUpdate"></span>
            <button class="refresh-btn" onclick="toggleLog()" title="API Log">ğŸ“‹</button>
        </div>
    </div>

    <div class="api-log" id="apiLog"></div>

    <div class="cors-warning" id="corsWarning">
        <strong>âš ï¸ UYARI: Bu dosyayÄ± doÄŸrudan (file://) aÃ§tÄ±nÄ±z!</strong><br>
        TarayÄ±cÄ±lar gÃ¼venlik (CORS) nedeniyle <code>file://</code> protokolÃ¼nde API Ã§aÄŸrÄ±larÄ±nÄ± engeller.
        Verilerin otomatik gÃ¼ncellenmesi iÃ§in aÅŸaÄŸÄ±daki yÃ¶ntemlerden birini kullanÄ±n:<br><br>
        <strong>YÃ¶ntem 1 (Ã–nerilen):</strong> VS Code'da <a
            href="https://marketplace.visualstudio.com/items?itemName=ritwickdey.LiveServer" target="_blank">Live
            Server</a> eklentisini yÃ¼kleyin â†’ dosyaya saÄŸ tÄ±klayÄ±n â†’ "Open with Live Server"<br>
        <strong>YÃ¶ntem 2:</strong> Komut satÄ±rÄ±nda <code>python -m http.server 8080</code> Ã§alÄ±ÅŸtÄ±rÄ±n â†’
        <code>http://localhost:8080</code> aÃ§Ä±n<br>
        <strong>YÃ¶ntem 3:</strong> Node.js: <code>npx serve .</code> Ã§alÄ±ÅŸtÄ±rÄ±n â†’ verilen adresi aÃ§Ä±n
    </div>

    <div class="container">
        <!-- DASHBOARD -->
        <div id="dashboard">
            <div class="asset-grid" id="assetGrid"></div>
        </div>

        <!-- DETAIL VIEW -->
        <div id="detailView">
            <div class="detail-header">
                <button class="back-btn" onclick="showDashboard()">â† Ana Sayfa</button>
                <span class="detail-title" id="detailTitle"></span>
                <span class="detail-price" id="detailPrice"></span>
                <span class="detail-change" id="detailChange"></span>
            </div>

            <div class="timeframe-btns" id="timeframeBtns">
                <button class="tf-btn" data-days="1">1G</button>
                <button class="tf-btn" data-days="7">7G</button>
                <button class="tf-btn" data-days="30">30G</button>
                <button class="tf-btn active" data-days="90">90G</button>
                <button class="tf-btn" data-days="180">180G</button>
                <button class="tf-btn" data-days="365">1Y</button>
            </div>

            <div class="indicator-grid" id="indicatorGrid"></div>

            <div class="chart-section">
                <h3>Fiyat GrafiÄŸi â€” MA / Bollinger / Fibonacci</h3>
                <div class="chart-wrapper main">
                    <canvas id="priceChart"></canvas>
                </div>
            </div>

            <div class="sub-charts">
                <div class="chart-section">
                    <h3>RSI (14)</h3>
                    <div class="chart-wrapper sub">
                        <canvas id="rsiChart"></canvas>
                    </div>
                </div>
                <div class="chart-section">
                    <h3>MACD (12, 26, 9)</h3>
                    <div class="chart-wrapper sub">
                        <canvas id="macdChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-section" style="margin-top:15px">
                <h3>ğŸŸ¢ğŸ”´ Al / Sat Sinyal GrafiÄŸi</h3>
                <div id="signalSummary" class="signal-summary"></div>
                <div class="chart-wrapper main">
                    <canvas id="signalChart"></canvas>
                </div>
            </div>

            <div class="chart-section" style="margin-top:15px">
                <h3>Fibonacci Seviyeleri</h3>
                <div id="fibTable"></div>
            </div>

            <div class="levels-grid">
                <div class="level-card buy-card">
                    <h3>ğŸ“¥ Kademeli AlÄ±m NoktalarÄ±</h3>
                    <div class="timeframe-btns" style="margin:10px 0">
                        <button class="tf-btn horizon-btn active" data-horizon="short"
                            onclick="changeHorizon('short')">KÄ±sa Vade</button>
                        <button class="tf-btn horizon-btn" data-horizon="medium" onclick="changeHorizon('medium')">Orta
                            Vade</button>
                        <button class="tf-btn horizon-btn" data-horizon="long" onclick="changeHorizon('long')">Uzun
                            Vade</button>
                    </div>
                    <div id="buyLevels"></div>
                </div>
                <div class="level-card sell-card">
                    <h3>ğŸ“¤ Kademeli SatÄ±m NoktalarÄ±</h3>
                    <div class="timeframe-btns" style="margin:10px 0">
                        <button class="tf-btn horizon-btn active" data-horizon="short"
                            onclick="changeHorizon('short')">KÄ±sa Vade</button>
                        <button class="tf-btn horizon-btn" data-horizon="medium" onclick="changeHorizon('medium')">Orta
                            Vade</button>
                        <button class="tf-btn horizon-btn" data-horizon="long" onclick="changeHorizon('long')">Uzun
                            Vade</button>
                    </div>
                    <div id="sellLevels"></div>
                </div>
            </div>

            <div class="analysis-box">
                <h3>ğŸ¤– Yapay Zeka Teknik Analiz Ã–zeti</h3>
                <div id="analysisText"></div>
            </div>

            <div class="disclaimer">
                <strong>âš ï¸ UyarÄ±:</strong> Bu platform yalnÄ±zca eÄŸitim ve bilgilendirme amaÃ§lÄ±dÄ±r, yatÄ±rÄ±m tavsiyesi
                niteliÄŸi taÅŸÄ±maz. Finansal piyasalar yÃ¼ksek risk iÃ§erir. YatÄ±rÄ±m kararlarÄ±nÄ±zÄ± lisanslÄ± finansal
                danÄ±ÅŸmanlara danÄ±ÅŸarak veriniz. GeÃ§miÅŸ performans gelecekteki sonuÃ§larÄ±n garantisi deÄŸildir.
            </div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const ASSETS = [
            { id: 'gram-gold', name: 'Gram AltÄ±n', icon: 'ğŸª™', unit: 'â‚º/g', type: 'metal', metal: 'gold', curr: 'TRY', gram: true },
            { id: 'gram-silver', name: 'Gram GÃ¼mÃ¼ÅŸ', icon: 'â¬œ', unit: 'â‚º/g', type: 'metal', metal: 'silver', curr: 'TRY', gram: true },
            { id: 'ons-gold', name: 'Ons AltÄ±n', icon: 'ğŸ¥‡', unit: '$/ons', type: 'metal', metal: 'gold', curr: 'USD', gram: false },
            { id: 'ons-silver', name: 'Ons GÃ¼mÃ¼ÅŸ', icon: 'ğŸ¥ˆ', unit: '$/ons', type: 'metal', metal: 'silver', curr: 'USD', gram: false },
            { id: 'btc', name: 'Bitcoin', icon: 'â‚¿', unit: '$', type: 'crypto', cgId: 'bitcoin', curr: 'USD' },
            { id: 'eth', name: 'Ethereum', icon: 'Î', unit: '$', type: 'crypto', cgId: 'ethereum', curr: 'USD' },
            { id: 'usdt', name: 'Tether USDT', icon: 'ğŸ’²', unit: '$', type: 'crypto', cgId: 'tether', curr: 'USD' },
        ];

        const TROY_OZ_GRAM = 31.1035;
        let state = {
            usdTry: 43.60,
            goldOz: 4860,
            silverOz: 73.68,
            prices: {},
            history: {},
            currentAsset: null,
            days: 90,
            charts: {},
            refreshInterval: null,
            countdown: 30,
            goldChange24h: 0,
            silverChange24h: 0,
            currentLevelData: null,
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // API LAYER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const apiStatus = { exchange: 'â³', crypto: 'â³', metals: 'â³' };

        function logApi(source, ok, detail) {
            const ts = new Date().toLocaleTimeString('tr-TR');
            apiStatus[source] = ok ? 'âœ…' : 'âŒ';
            const el = document.getElementById('apiLog');
            const line = `<div class="${ok ? 'api-ok' : 'api-fail'}">[${ts}] ${source}: ${detail}</div>`;
            el.innerHTML = line + el.innerHTML;
            // Keep max 20 lines
            const lines = el.querySelectorAll('div');
            if (lines.length > 20) for (let i = 20; i < lines.length; i++) lines[i].remove();
        }

        function toggleLog() {
            document.getElementById('apiLog').classList.toggle('visible');
        }

        async function fetchJSON(url, timeout = 10000) {
            try {
                const controller = new AbortController();
                const timer = setTimeout(() => controller.abort(), timeout);
                const r = await fetch(url, {
                    signal: controller.signal,
                    cache: 'no-cache',
                    headers: { 'Accept': 'application/json' }
                });
                clearTimeout(timer);
                if (!r.ok) throw new Error('HTTP ' + r.status);
                return await r.json();
            } catch (e) {
                console.warn('API fail:', url, e.message);
                return null;
            }
        }

        async function fetchExchangeRate() {
            // Try primary
            let d = await fetchJSON('https://open.er-api.com/v6/latest/USD');
            if (d && d.rates && d.rates.TRY) {
                state.usdTry = d.rates.TRY;
                logApi('exchange', true, `USD/TRY = ${d.rates.TRY.toFixed(2)}`);
                return true;
            }
            // Fallback
            d = await fetchJSON('https://api.exchangerate-api.com/v4/latest/USD');
            if (d && d.rates && d.rates.TRY) {
                state.usdTry = d.rates.TRY;
                logApi('exchange', true, `(yedek) USD/TRY = ${d.rates.TRY.toFixed(2)}`);
                return true;
            }
            logApi('exchange', false, 'Kur verisi alÄ±namadÄ±');
            return false;
        }

        async function fetchCryptoPrices() {
            // Primary: Binance public API (en gÃ¼venilir, rate limit yok)
            try {
                const [btcB, ethB, usdtB] = await Promise.all([
                    fetchJSON('https://api.binance.com/api/v3/ticker/24hr?symbol=BTCUSDT'),
                    fetchJSON('https://api.binance.com/api/v3/ticker/24hr?symbol=ETHUSDT'),
                    fetchJSON('https://api.binance.com/api/v3/ticker/24hr?symbol=USDCUSDT')
                ]);
                if (btcB && btcB.lastPrice) {
                    state.prices['btc'] = { price: parseFloat(btcB.lastPrice), change24h: parseFloat(btcB.priceChangePercent) || 0 };
                    state.prices['eth'] = ethB ? { price: parseFloat(ethB.lastPrice), change24h: parseFloat(ethB.priceChangePercent) || 0 } : state.prices['eth'];
                    state.prices['usdt'] = { price: 1.0, change24h: usdtB ? -(parseFloat(usdtB.priceChangePercent) || 0) : 0 };
                    logApi('crypto', true, `(Binance) BTC=$${parseFloat(btcB.lastPrice).toLocaleString()} ETH=$${ethB ? parseFloat(ethB.lastPrice).toLocaleString() : '?'}`);
                    return true;
                }
            } catch (e) { console.warn('Binance fail:', e); }
            // Fallback 1: CoinGecko (rate limit riski var)
            let d = await fetchJSON('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,tether&vs_currencies=usd&include_24hr_change=true');
            if (d && (d.bitcoin || d.ethereum)) {
                if (d.bitcoin) state.prices['btc'] = { price: d.bitcoin.usd, change24h: d.bitcoin.usd_24h_change || 0 };
                if (d.ethereum) state.prices['eth'] = { price: d.ethereum.usd, change24h: d.ethereum.usd_24h_change || 0 };
                if (d.tether) state.prices['usdt'] = { price: d.tether.usd, change24h: d.tether.usd_24h_change || 0 };
                logApi('crypto', true, `(CoinGecko) BTC=$${d.bitcoin?.usd?.toLocaleString() || '?'} ETH=$${d.ethereum?.usd?.toLocaleString() || '?'}`);
                return true;
            }
            // Fallback 2: CoinCap API
            try {
                const [btcR, ethR] = await Promise.all([
                    fetchJSON('https://api.coincap.io/v2/assets/bitcoin'),
                    fetchJSON('https://api.coincap.io/v2/assets/ethereum')
                ]);
                if (btcR?.data) state.prices['btc'] = { price: parseFloat(btcR.data.priceUsd), change24h: parseFloat(btcR.data.changePercent24Hr) || 0 };
                if (ethR?.data) state.prices['eth'] = { price: parseFloat(ethR.data.priceUsd), change24h: parseFloat(ethR.data.changePercent24Hr) || 0 };
                state.prices['usdt'] = state.prices['usdt'] || { price: 1.0, change24h: 0 };
                logApi('crypto', true, `(CoinCap) BTC=$${state.prices['btc']?.price?.toLocaleString() || '?'}`);
                return true;
            } catch (e) { }
            logApi('crypto', false, 'Kripto verisi alÄ±namadÄ± - tÃ¼m kaynaklar baÅŸarÄ±sÄ±z');
            return false;
        }

        async function fetchMetalPrices() {
            let success = false;
            // Primary: goldprice.org API (gÃ¼venilir, CORS destekli)
            try {
                const d = await fetchJSON('https://data-asg.goldprice.org/dbXRates/USD');
                if (d && d.items && d.items.length > 0) {
                    const item = d.items[0];
                    if (item.xauPrice) {
                        state.goldOz = item.xauPrice;
                        state.goldChange24h = item.pcXau || 0;
                    }
                    if (item.xagPrice) {
                        state.silverOz = item.xagPrice;
                        state.silverChange24h = item.pcXag || 0;
                    }
                    success = true;
                    logApi('metals', true, `(goldprice.org) Au=$${state.goldOz.toFixed(2)} (${state.goldChange24h > 0 ? '+' : ''}${state.goldChange24h.toFixed(2)}%) Ag=$${state.silverOz.toFixed(2)} (${state.silverChange24h > 0 ? '+' : ''}${state.silverChange24h.toFixed(2)}%)`);
                }
            } catch (e) { console.warn('goldprice.org fail:', e); }
            // Fallback 1: metals.live API
            if (!success) {
                const d = await fetchJSON('https://api.metals.live/v1/spot');
                if (d && Array.isArray(d)) {
                    d.forEach(m => {
                        if (m.gold) state.goldOz = m.gold;
                        if (m.silver) state.silverOz = m.silver;
                    });
                    success = true;
                    logApi('metals', true, `(metals.live) Au=$${state.goldOz} Ag=$${state.silverOz}`);
                }
            }
            // Fallback 2: Swissquote forex feed
            if (!success) {
                try {
                    const [goldR, silverR] = await Promise.all([
                        fetchJSON('https://forex-data-feed.swissquote.com/public-quotes/bboquotes/instrument/XAU/USD'),
                        fetchJSON('https://forex-data-feed.swissquote.com/public-quotes/bboquotes/instrument/XAG/USD')
                    ]);
                    if (goldR && Array.isArray(goldR) && goldR[0]?.spreadProfilePrices) {
                        const gp = goldR[0].spreadProfilePrices[0];
                        state.goldOz = (gp.bid + gp.ask) / 2;
                    }
                    if (silverR && Array.isArray(silverR) && silverR[0]?.spreadProfilePrices) {
                        const sp = silverR[0].spreadProfilePrices[0];
                        state.silverOz = (sp.bid + sp.ask) / 2;
                    }
                    if (state.goldOz > 0) {
                        success = true;
                        logApi('metals', true, `(Swissquote) Au=$${state.goldOz.toFixed(2)} Ag=$${state.silverOz.toFixed(2)}`);
                    }
                } catch (e) { console.warn('Swissquote fail:', e); }
            }
            if (!success) {
                logApi('metals', false, 'Metal verisi alÄ±namadÄ±, Ã¶nceki deÄŸerler korunuyor');
            }
            // Calculate all metal prices with 24h change
            const goldChg = state.goldChange24h || 0;
            const silverChg = state.silverChange24h || 0;
            state.prices['ons-gold'] = { price: state.goldOz, change24h: goldChg };
            state.prices['ons-silver'] = { price: state.silverOz, change24h: silverChg };
            state.prices['gram-gold'] = { price: (state.goldOz * state.usdTry) / TROY_OZ_GRAM, change24h: goldChg };
            state.prices['gram-silver'] = { price: (state.silverOz * state.usdTry) / TROY_OZ_GRAM, change24h: silverChg };
            return success;
        }

        async function fetchCryptoHistory(cgId, days) {
            // Primary: Binance klines API (en gÃ¼venilir)
            const cgToBinance = { bitcoin: 'BTCUSDT', ethereum: 'ETHUSDT', tether: 'USDCUSDT' };
            const binanceSymbol = cgToBinance[cgId];
            if (binanceSymbol) {
                try {
                    const interval = days <= 1 ? '15m' : days <= 7 ? '1h' : days <= 30 ? '4h' : '1d';
                    const limit = days <= 1 ? 96 : days <= 7 ? days * 24 : days <= 30 ? days * 6 : days;
                    const d = await fetchJSON(`https://api.binance.com/api/v3/klines?symbol=${binanceSymbol}&interval=${interval}&limit=${Math.min(limit, 1000)}`);
                    if (d && Array.isArray(d) && d.length > 0) {
                        return d.map(k => ({ t: k[0], c: parseFloat(k[4]) })); // k[4] = close price
                    }
                } catch (e) { console.warn('Binance klines fail:', e); }
            }
            // Fallback 1: CoinGecko
            let d = await fetchJSON(`https://api.coingecko.com/api/v3/coins/${cgId}/market_chart?vs_currency=usd&days=${days}`);
            if (d && d.prices) {
                return d.prices.map(p => ({ t: p[0], c: p[1] }));
            }
            // Fallback 2: CoinCap history
            const cgToCoinCap = { bitcoin: 'bitcoin', ethereum: 'ethereum', tether: 'tether' };
            const capId = cgToCoinCap[cgId];
            if (capId) {
                const now = Date.now();
                const start = now - days * 86400000;
                const intv = days <= 7 ? 'h1' : days <= 90 ? 'h6' : 'd1';
                const d2 = await fetchJSON(`https://api.coincap.io/v2/assets/${capId}/history?interval=${intv}&start=${start}&end=${now}`);
                if (d2 && d2.data) {
                    return d2.data.map(p => ({ t: p.time, c: parseFloat(p.priceUsd) }));
                }
            }
            return null;
        }

        // Generate realistic historical data for metals
        function generateMetalHistory(currentPrice, days, volatility) {
            const data = [];
            const now = Date.now();
            const dayMs = 86400000;
            // Work backwards from current price
            let price = currentPrice;
            const prices = [price];
            for (let i = 1; i <= days; i++) {
                const change = (Math.random() - 0.48) * volatility * price;
                price = price - change; // going backwards
                prices.unshift(price);
            }
            // Normalize so last price matches current
            const scale = currentPrice / prices[prices.length - 1];
            for (let i = 0; i <= days; i++) {
                data.push({ t: now - (days - i) * dayMs, c: prices[i] * scale });
            }
            // Add some intraday points for smoother chart
            const result = [];
            for (let i = 0; i < data.length - 1; i++) {
                result.push(data[i]);
                const mid = { t: (data[i].t + data[i + 1].t) / 2, c: (data[i].c + data[i + 1].c) / 2 + (Math.random() - 0.5) * volatility * data[i].c * 0.3 };
                result.push(mid);
            }
            result.push(data[data.length - 1]);
            return result;
        }

        async function fetchHistory(asset, days) {
            if (asset.type === 'crypto') {
                const hist = await fetchCryptoHistory(asset.cgId, days);
                if (hist) { state.history[asset.id] = hist; return; }
            }
            // Metal or fallback
            let price, vol;
            if (asset.metal === 'gold' && !asset.gram) { price = state.goldOz; vol = 0.012; }
            else if (asset.metal === 'silver' && !asset.gram) { price = state.silverOz; vol = 0.018; }
            else if (asset.metal === 'gold' && asset.gram) { price = state.prices['gram-gold']?.price || 6800; vol = 0.014; }
            else if (asset.metal === 'silver' && asset.gram) { price = state.prices['gram-silver']?.price || 103; vol = 0.02; }
            else { price = 100; vol = 0.015; }
            state.history[asset.id] = generateMetalHistory(price, days, vol);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TECHNICAL INDICATORS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function SMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) { result.push(null); continue; }
                let sum = 0;
                for (let j = 0; j < period; j++) sum += data[i - j];
                result.push(sum / period);
            }
            return result;
        }

        function EMA(data, period) {
            const k = 2 / (period + 1);
            const result = [data[0]];
            for (let i = 1; i < data.length; i++) {
                result.push(data[i] * k + result[i - 1] * (1 - k));
            }
            return result;
        }

        function RSI(data, period = 14) {
            const result = [];
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                const diff = data[i] - data[i - 1];
                if (diff > 0) gains += diff; else losses -= diff;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            for (let i = 0; i < period; i++) result.push(null);
            result.push(avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss));
            for (let i = period + 1; i < data.length; i++) {
                const diff = data[i] - data[i - 1];
                avgGain = (avgGain * (period - 1) + Math.max(diff, 0)) / period;
                avgLoss = (avgLoss * (period - 1) + Math.max(-diff, 0)) / period;
                result.push(avgLoss === 0 ? 100 : 100 - 100 / (1 + avgGain / avgLoss));
            }
            return result;
        }

        function MACD(data, fast = 12, slow = 26, sig = 9) {
            const emaFast = EMA(data, fast);
            const emaSlow = EMA(data, slow);
            const macdLine = emaFast.map((v, i) => v - emaSlow[i]);
            const signalLine = EMA(macdLine, sig);
            const histogram = macdLine.map((v, i) => v - signalLine[i]);
            return { macd: macdLine, signal: signalLine, histogram };
        }

        function BollingerBands(data, period = 20, mult = 2) {
            const sma = SMA(data, period);
            const upper = [], lower = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) { upper.push(null); lower.push(null); continue; }
                let variance = 0;
                for (let j = 0; j < period; j++) variance += Math.pow(data[i - j] - sma[i], 2);
                const std = Math.sqrt(variance / period);
                upper.push(sma[i] + mult * std);
                lower.push(sma[i] - mult * std);
            }
            return { upper, middle: sma, lower };
        }

        function FibonacciLevels(high, low) {
            const diff = high - low;
            return [
                { level: '0.0%', price: low, color: '#ff5050' },
                { level: '23.6%', price: low + diff * 0.236, color: '#ff8c00' },
                { level: '38.2%', price: low + diff * 0.382, color: '#ffc800' },
                { level: '50.0%', price: low + diff * 0.5, color: '#4488ff' },
                { level: '61.8%', price: low + diff * 0.618, color: '#00e070' },
                { level: '78.6%', price: low + diff * 0.786, color: '#b470ff' },
                { level: '100.0%', price: high, color: '#ff5050' },
            ];
        }

        function linearRegression(data) {
            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) { sumX += i; sumY += data[i]; sumXY += i * data[i]; sumXX += i * i; }
            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            return { slope, intercept, line: data.map((_, i) => intercept + slope * i) };
        }

        function findSupRes(data, window = 5) {
            const supports = [], resistances = [];
            for (let i = window; i < data.length - window; i++) {
                let isMin = true, isMax = true;
                for (let j = 1; j <= window; j++) {
                    if (data[i] > data[i - j] || data[i] > data[i + j]) isMin = false;
                    if (data[i] < data[i - j] || data[i] < data[i + j]) isMax = false;
                }
                if (isMin) supports.push(data[i]);
                if (isMax) resistances.push(data[i]);
            }
            return { supports: [...new Set(supports)].sort((a, b) => b - a).slice(0, 5), resistances: [...new Set(resistances)].sort((a, b) => a - b).slice(0, 5) };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BUY/SELL SIGNAL ENGINE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function generateSignals(closes, timestamps, sma20, sma50, rsi, macd, bb) {
            const signals = [];
            const details = { rsi: 'NÃ¶tr', macd: 'NÃ¶tr', sma: 'NÃ¶tr', bb: 'NÃ¶tr', trend: 'NÃ¶tr', volume: 'NÃ¶tr' };
            let score = 0; // -100 to +100

            for (let i = 1; i < closes.length; i++) {
                let sig = null;

                // RSI sinyalleri
                if (rsi[i] !== null && rsi[i - 1] !== null) {
                    if (rsi[i - 1] < 30 && rsi[i] >= 30) {
                        sig = { t: timestamps[i], price: closes[i], type: 'buy', reason: 'RSI aÅŸÄ±rÄ± satÄ±mdan Ã§Ä±kÄ±ÅŸ (30 Ã¼stÃ¼)' };
                    } else if (rsi[i - 1] > 70 && rsi[i] <= 70) {
                        sig = { t: timestamps[i], price: closes[i], type: 'sell', reason: 'RSI aÅŸÄ±rÄ± alÄ±mdan dÃ¼ÅŸÃ¼ÅŸ (70 altÄ±)' };
                    }
                }

                // MACD crossover sinyalleri
                if (macd.macd[i] !== undefined && macd.signal[i] !== undefined && i > 0) {
                    const prevDiff = macd.macd[i - 1] - macd.signal[i - 1];
                    const currDiff = macd.macd[i] - macd.signal[i];
                    if (prevDiff <= 0 && currDiff > 0) {
                        sig = { t: timestamps[i], price: closes[i], type: 'buy', reason: 'MACD yukarÄ± kesiÅŸim (Golden Cross)' };
                    } else if (prevDiff >= 0 && currDiff < 0) {
                        sig = { t: timestamps[i], price: closes[i], type: 'sell', reason: 'MACD aÅŸaÄŸÄ± kesiÅŸim (Death Cross)' };
                    }
                }

                // SMA crossover (20/50)
                if (sma20[i] !== null && sma50[i] !== null && sma20[i - 1] !== null && sma50[i - 1] !== null) {
                    if (sma20[i - 1] <= sma50[i - 1] && sma20[i] > sma50[i]) {
                        sig = { t: timestamps[i], price: closes[i], type: 'buy', reason: 'SMA 20/50 AltÄ±n KesiÅŸim (Golden Cross)' };
                    } else if (sma20[i - 1] >= sma50[i - 1] && sma20[i] < sma50[i]) {
                        sig = { t: timestamps[i], price: closes[i], type: 'sell', reason: 'SMA 20/50 Ã–lÃ¼m KesiÅŸimi (Death Cross)' };
                    }
                }

                // Bollinger Band sinyalleri
                if (bb.lower[i] !== null && bb.upper[i] !== null) {
                    if (closes[i - 1] <= bb.lower[i - 1] && closes[i] > bb.lower[i]) {
                        sig = { t: timestamps[i], price: closes[i], type: 'buy', reason: 'Fiyat Bollinger alt bandÄ±ndan yukarÄ± kÄ±rÄ±ldÄ±' };
                    } else if (closes[i - 1] >= bb.upper[i - 1] && closes[i] < bb.upper[i]) {
                        sig = { t: timestamps[i], price: closes[i], type: 'sell', reason: 'Fiyat Bollinger Ã¼st bandÄ±ndan aÅŸaÄŸÄ± kÄ±rÄ±ldÄ±' };
                    }
                }

                if (sig) signals.push(sig);
            }

            // Son deÄŸerlere gÃ¶re skor hesapla
            const lastIdx = closes.length - 1;
            const lastRsi = rsi.filter(v => v !== null).pop() || 50;
            const lastMacdVal = macd.macd[lastIdx];
            const lastSignalVal = macd.signal[lastIdx];
            const lastSma20 = sma20.filter(v => v !== null).pop();
            const lastSma50 = sma50.filter(v => v !== null).pop();
            const lastBBU = bb.upper.filter(v => v !== null).pop();
            const lastBBL = bb.lower.filter(v => v !== null).pop();
            const lastBBM = bb.middle.filter(v => v !== null).pop();
            const lastClose = closes[lastIdx];

            // RSI skoru (-20 to +20)
            if (lastRsi < 25) { score += 20; details.rsi = 'GÃ¼Ã§lÃ¼ Al'; }
            else if (lastRsi < 35) { score += 12; details.rsi = 'Al'; }
            else if (lastRsi < 45) { score += 5; details.rsi = 'Hafif Al'; }
            else if (lastRsi > 75) { score -= 20; details.rsi = 'GÃ¼Ã§lÃ¼ Sat'; }
            else if (lastRsi > 65) { score -= 12; details.rsi = 'Sat'; }
            else if (lastRsi > 55) { score -= 5; details.rsi = 'Hafif Sat'; }
            else { details.rsi = 'NÃ¶tr'; }

            // MACD skoru (-20 to +20)
            if (lastMacdVal > lastSignalVal) {
                const strength = Math.abs(lastMacdVal - lastSignalVal) / lastClose * 10000;
                if (strength > 5) { score += 20; details.macd = 'GÃ¼Ã§lÃ¼ Al'; }
                else { score += 10; details.macd = 'Al'; }
            } else {
                const strength = Math.abs(lastMacdVal - lastSignalVal) / lastClose * 10000;
                if (strength > 5) { score -= 20; details.macd = 'GÃ¼Ã§lÃ¼ Sat'; }
                else { score -= 10; details.macd = 'Sat'; }
            }

            // SMA skoru (-20 to +20)
            if (lastClose > lastSma20 && lastSma20 > lastSma50) { score += 20; details.sma = 'GÃ¼Ã§lÃ¼ Al'; }
            else if (lastClose > lastSma20) { score += 10; details.sma = 'Al'; }
            else if (lastClose < lastSma20 && lastSma20 < lastSma50) { score -= 20; details.sma = 'GÃ¼Ã§lÃ¼ Sat'; }
            else if (lastClose < lastSma20) { score -= 10; details.sma = 'Sat'; }

            // BB skoru (-20 to +20)
            const bbPct = (lastClose - lastBBL) / (lastBBU - lastBBL);
            if (bbPct < 0.1) { score += 15; details.bb = 'GÃ¼Ã§lÃ¼ Al'; }
            else if (bbPct < 0.3) { score += 8; details.bb = 'Al'; }
            else if (bbPct > 0.9) { score -= 15; details.bb = 'GÃ¼Ã§lÃ¼ Sat'; }
            else if (bbPct > 0.7) { score -= 8; details.bb = 'Sat'; }
            else { details.bb = 'NÃ¶tr'; }

            // Trend skoru (-20 to +20)
            const trendPct = (closes[lastIdx] - closes[Math.max(0, lastIdx - 20)]) / closes[Math.max(0, lastIdx - 20)] * 100;
            if (trendPct > 5) { score += 15; details.trend = 'GÃ¼Ã§lÃ¼ Al'; }
            else if (trendPct > 1) { score += 8; details.trend = 'Al'; }
            else if (trendPct < -5) { score -= 15; details.trend = 'GÃ¼Ã§lÃ¼ Sat'; }
            else if (trendPct < -1) { score -= 8; details.trend = 'Sat'; }
            else { details.trend = 'NÃ¶tr'; }

            // Normalize to -100 to +100
            score = Math.max(-100, Math.min(100, score));

            let overall, overallClass;
            if (score >= 40) { overall = 'ğŸŸ¢ GÃœÃ‡LÃœ AL'; overallClass = 'buy'; }
            else if (score >= 15) { overall = 'ğŸŸ¢ AL'; overallClass = 'buy'; }
            else if (score > -15) { overall = 'âšª NÃ–TR'; overallClass = 'neutral'; }
            else if (score > -40) { overall = 'ğŸ”´ SAT'; overallClass = 'sell'; }
            else { overall = 'ğŸ”´ GÃœÃ‡LÃœ SAT'; overallClass = 'sell'; }

            return { signals, score, overall, overallClass, details };
        }

        // Quick signal for dashboard cards
        function getQuickSignal(assetId) {
            const hist = state.history[assetId];
            if (!hist || hist.length < 30) return null;
            let closes = hist.map(h => h.c);
            if (closes.length > 200) {
                const step = Math.ceil(closes.length / 150);
                const nc = [];
                for (let i = 0; i < closes.length; i += step) nc.push(closes[i]);
                if (nc[nc.length - 1] !== closes[closes.length - 1]) nc.push(closes[closes.length - 1]);
                closes = nc;
            }
            const sma20 = SMA(closes, Math.min(20, Math.floor(closes.length * 0.3)));
            const sma50 = SMA(closes, Math.min(50, Math.floor(closes.length * 0.5)));
            const rsi = RSI(closes, 14);
            const macdData = MACD(closes, 12, 26, 9);
            const bb = BollingerBands(closes, Math.min(20, Math.floor(closes.length * 0.3)), 2);
            const result = generateSignals(closes, hist.map(h => h.t), sma20, sma50, rsi, macdData, bb);
            return result;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FORMAT HELPERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function fmt(val, asset) {
            if (!val && val !== 0) return 'â€”';
            const a = ASSETS.find(x => x.id === (asset?.id || asset)) || asset || {};
            if (a.curr === 'TRY') return 'â‚º' + val.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (a.id === 'btc' || a.id === 'eth') return '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (a.id === 'usdt') return '$' + val.toFixed(4);
            return '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function fmtPct(val) {
            if (!val && val !== 0) return 'â€”';
            const sign = val >= 0 ? '+' : '';
            return sign + val.toFixed(2) + '%';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DASHBOARD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderDashboard() {
            const grid = document.getElementById('assetGrid');
            grid.innerHTML = '';
            ASSETS.forEach(asset => {
                const p = state.prices[asset.id];
                const card = document.createElement('div');
                card.className = 'asset-card';
                card.onclick = () => showDetail(asset.id);
                const price = p ? fmt(p.price, asset) : '<span class="loading-pulse">YÃ¼kleniyor...</span>';
                const chg = p ? p.change24h : null;
                const chgClass = chg >= 0 ? 'up' : 'down';
                const chgText = chg !== null && chg !== 0 ? fmtPct(chg) : '';

                // Quick signal badge
                let signalHtml = '';
                const sig = getQuickSignal(asset.id);
                if (sig) {
                    let badgeClass = 'neutral';
                    if (sig.score >= 40) badgeClass = 'strong-buy';
                    else if (sig.score >= 15) badgeClass = 'buy';
                    else if (sig.score <= -40) badgeClass = 'strong-sell';
                    else if (sig.score <= -15) badgeClass = 'sell';
                    signalHtml = `<div class="signal-badge-card ${badgeClass}">${sig.overall}</div>`;
                }

                card.innerHTML = `
            <div class="icon">${asset.icon}</div>
            <div class="name">${asset.name}</div>
            <div class="price">${price}</div>
            ${chgText ? `<div class="change ${chgClass}">${chgText} (24s)</div>` : '<div class="unit" style="height:20px"></div>'}
            <div class="unit">${asset.unit}</div>
            ${signalHtml}
        `;
                grid.appendChild(card);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DETAIL VIEW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function showDetail(assetId) {
            const asset = ASSETS.find(a => a.id === assetId);
            if (!asset) return;
            state.currentAsset = asset;

            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('detailView').style.display = 'block';
            document.getElementById('detailTitle').textContent = asset.icon + ' ' + asset.name;

            const p = state.prices[asset.id];
            document.getElementById('detailPrice').textContent = p ? fmt(p.price, asset) : '...';
            const chg = p?.change24h || 0;
            const chgEl = document.getElementById('detailChange');
            chgEl.textContent = fmtPct(chg);
            chgEl.style.color = chg >= 0 ? 'var(--green)' : 'var(--red)';

            // Setup timeframe buttons
            document.querySelectorAll('.tf-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.days) === state.days) btn.classList.add('active');
                btn.onclick = async () => {
                    state.days = parseInt(btn.dataset.days);
                    document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    await loadAndRenderDetail(asset);
                };
            });

            await loadAndRenderDetail(asset);
        }

        async function loadAndRenderDetail(asset) {
            // Show loading
            document.getElementById('indicatorGrid').innerHTML = '<div class="loader"><div class="spinner"></div>Veriler yÃ¼kleniyor...</div>';

            await fetchHistory(asset, state.days);
            const hist = state.history[asset.id];
            if (!hist || hist.length < 10) {
                document.getElementById('indicatorGrid').innerHTML = '<div class="loader">Veri alÄ±namadÄ±. LÃ¼tfen tekrar deneyin.</div>';
                return;
            }

            // For TRY gram assets, convert if history is in USD ounce
            let closes = hist.map(h => h.c);
            let timestamps = hist.map(h => h.t);

            // Downsample if too many points (for cleaner indicators)
            if (closes.length > 500) {
                const step = Math.ceil(closes.length / 300);
                const nc = [], nt = [];
                for (let i = 0; i < closes.length; i += step) { nc.push(closes[i]); nt.push(timestamps[i]); }
                // Always include last point
                if (nc[nc.length - 1] !== closes[closes.length - 1]) { nc.push(closes[closes.length - 1]); nt.push(timestamps[timestamps.length - 1]); }
                closes = nc; timestamps = nt;
            }

            // Calculate indicators
            const smaPeriod20 = Math.min(20, Math.floor(closes.length * 0.3));
            const smaPeriod50 = Math.min(50, Math.floor(closes.length * 0.4));
            const sma20 = SMA(closes, Math.max(2, smaPeriod20));
            const sma50 = SMA(closes, Math.max(2, smaPeriod50));
            const sma200 = closes.length >= 200 ? SMA(closes, 200) : SMA(closes, Math.max(2, Math.floor(closes.length * 0.8)));
            const rsiPeriod = Math.min(14, Math.floor(closes.length * 0.3));
            const rsi = RSI(closes, Math.max(2, rsiPeriod));
            const macd = MACD(closes, Math.min(12, Math.floor(closes.length * 0.2)), Math.min(26, Math.floor(closes.length * 0.4)), 9);
            const bbPeriod = Math.min(20, Math.floor(closes.length * 0.3));
            const bb = BollingerBands(closes, Math.max(2, bbPeriod), 2);
            const trend = linearRegression(closes);

            const high = Math.max(...closes);
            const low = Math.min(...closes);
            const fib = FibonacciLevels(high, low);
            const supRes = findSupRes(closes, Math.max(3, Math.floor(closes.length * 0.03)));

            const lastClose = closes[closes.length - 1];
            const lastRsi = rsi.filter(v => v !== null).pop() || 50;
            const lastMacd = macd.macd[macd.macd.length - 1];
            const lastSignal = macd.signal[macd.signal.length - 1];
            const lastSma20 = sma20.filter(v => v !== null).pop();
            const lastSma50 = sma50.filter(v => v !== null).pop();
            const lastBBU = bb.upper.filter(v => v !== null).pop();
            const lastBBL = bb.lower.filter(v => v !== null).pop();
            const lastBBM = bb.middle.filter(v => v !== null).pop();

            // Render indicator cards
            renderIndicators(asset, lastClose, lastRsi, lastMacd, lastSignal, lastSma20, lastSma50, lastBBU, lastBBL, trend);

            // Render charts
            renderPriceChart(asset, timestamps, closes, sma20, sma50, sma200, bb, fib, trend);
            renderRSIChart(timestamps, rsi);
            renderMACDChart(timestamps, macd);

            // Generate & render buy/sell signal chart
            const signalData = generateSignals(closes, timestamps, sma20, sma50, rsi, macd, bb);
            renderSignalChart(asset, timestamps, closes, signalData);
            renderSignalSummary(asset, signalData);

            // Fibonacci table
            renderFibTable(asset, fib, lastClose);

            // Buy/Sell levels
            renderBuySellLevels(asset, lastClose, fib, supRes, lastRsi, bb, state.days);

            // Store current data for horizon changes
            state.currentLevelData = { asset, price: lastClose, fib, supRes, rsi: lastRsi, bb, days: state.days };

            // AI Analysis
            renderAnalysis(asset, lastClose, lastRsi, lastMacd, lastSignal, lastSma20, lastSma50, lastBBU, lastBBL, lastBBM, trend, fib, high, low, closes);
        }

        function renderIndicators(asset, price, rsi, macd, signal, sma20, sma50, bbU, bbL, trend) {
            const grid = document.getElementById('indicatorGrid');
            const trendDir = trend.slope > 0 ? 'YÃ¼kseliÅŸ' : 'DÃ¼ÅŸÃ¼ÅŸ';
            const trendClr = trend.slope > 0 ? 'var(--green)' : 'var(--red)';
            const rsiSignal = rsi < 30 ? ['AÅŸÄ±rÄ± SatÄ±m', 'signal-buy'] : rsi > 70 ? ['AÅŸÄ±rÄ± AlÄ±m', 'signal-sell'] : ['NÃ¶tr', 'signal-neutral'];
            const macdSignal = macd > signal ? ['YÃ¼kseliÅŸ', 'signal-buy'] : ['DÃ¼ÅŸÃ¼ÅŸ', 'signal-sell'];
            const bbPos = price > bbU ? ['Ãœst Band ÃœstÃ¼', 'signal-sell'] : price < bbL ? ['Alt Band AltÄ±', 'signal-buy'] : ['Band Ä°Ã§i', 'signal-neutral'];
            const maPos = price > sma20 ? ['MA ÃœstÃ¼', 'signal-buy'] : ['MA AltÄ±', 'signal-sell'];

            grid.innerHTML = `
        <div class="ind-card"><div class="ind-label">Fiyat</div><div class="ind-value" style="color:var(--accent)">${fmt(price, asset)}</div></div>
        <div class="ind-card"><div class="ind-label">Trend</div><div class="ind-value" style="color:${trendClr}">${trendDir}</div></div>
        <div class="ind-card"><div class="ind-label">RSI (14)</div><div class="ind-value">${rsi.toFixed(1)}</div><div class="ind-signal ${rsiSignal[1]}">${rsiSignal[0]}</div></div>
        <div class="ind-card"><div class="ind-label">MACD</div><div class="ind-value">${macd.toFixed(4)}</div><div class="ind-signal ${macdSignal[1]}">${macdSignal[0]}</div></div>
        <div class="ind-card"><div class="ind-label">SMA 20</div><div class="ind-value">${fmt(sma20, asset)}</div><div class="ind-signal ${maPos[1]}">${maPos[0]}</div></div>
        <div class="ind-card"><div class="ind-label">SMA 50</div><div class="ind-value">${fmt(sma50, asset)}</div></div>
        <div class="ind-card"><div class="ind-label">Bollinger Ãœst</div><div class="ind-value">${fmt(bbU, asset)}</div></div>
        <div class="ind-card"><div class="ind-label">Bollinger Alt</div><div class="ind-value">${fmt(bbL, asset)}</div></div>
        <div class="ind-card"><div class="ind-label">BB Pozisyon</div><div class="ind-value" style="font-size:.9em">${bbPos[0]}</div><div class="ind-signal ${bbPos[1]}">${bbPos[0]}</div></div>
    `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CHARTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function destroyCharts() {
            ['priceChart', 'rsiChart', 'macdChart', 'signalChart'].forEach(id => { if (state.charts[id]) { state.charts[id].destroy(); delete state.charts[id]; } });
        }

        function renderPriceChart(asset, timestamps, closes, sma20, sma50, sma200, bb, fib, trend) {
            if (state.charts.priceChart) state.charts.priceChart.destroy();
            const ctx = document.getElementById('priceChart').getContext('2d');
            const labels = timestamps.map(t => new Date(t));

            // Fibonacci annotation lines
            const annotations = {};
            fib.forEach((f, i) => {
                annotations['fib' + i] = {
                    type: 'line', yMin: f.price, yMax: f.price,
                    borderColor: f.color + '55', borderWidth: 1, borderDash: [4, 4],
                    label: { display: true, content: `Fib ${f.level}`, position: 'start', font: { size: 9 }, color: f.color + 'aa', backgroundColor: 'transparent' }
                };
            });
            // Trend line
            annotations.trend = {
                type: 'line',
                yMin: trend.line[0], yMax: trend.line[trend.line.length - 1],
                xMin: labels[0], xMax: labels[labels.length - 1],
                borderColor: '#ffd70066', borderWidth: 2, borderDash: [6, 3],
            };

            state.charts.priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Fiyat', data: closes, borderColor: '#ffd700', backgroundColor: 'rgba(255,215,0,0.05)', borderWidth: 2, pointRadius: 0, fill: true, order: 2 },
                        { label: 'SMA 20', data: sma20, borderColor: '#4488ff88', borderWidth: 1.5, pointRadius: 0, fill: false, order: 3 },
                        { label: 'SMA 50', data: sma50, borderColor: '#ff8c0088', borderWidth: 1.5, pointRadius: 0, fill: false, order: 3 },
                        { label: 'BB Ãœst', data: bb.upper, borderColor: '#b470ff44', borderWidth: 1, pointRadius: 0, fill: false, order: 4 },
                        { label: 'BB Alt', data: bb.lower, borderColor: '#b470ff44', borderWidth: 1, pointRadius: 0, fill: '-1', backgroundColor: 'rgba(180,112,255,0.04)', order: 4 },
                        { label: 'Trend', data: trend.line, borderColor: '#ffd70033', borderWidth: 1.5, borderDash: [6, 3], pointRadius: 0, fill: false, order: 5 },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#8888bb', font: { size: 11 }, usePointStyle: true, pointStyle: 'line' } },
                        annotation: { annotations },
                        tooltip: {
                            backgroundColor: 'rgba(15,15,50,0.95)', titleColor: '#ffd700', bodyColor: '#ccc', borderColor: '#333', borderWidth: 1,
                            callbacks: { label: function (ctx2) { return ctx2.dataset.label + ': ' + fmt(ctx2.raw, asset); } }
                        }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: state.days <= 1 ? 'hour' : state.days <= 30 ? 'day' : state.days <= 180 ? 'week' : 'month' }, ticks: { color: '#666', maxTicksLimit: 12 }, grid: { color: '#1a1a4a' } },
                        y: { ticks: { color: '#666', callback: v => fmt(v, asset) }, grid: { color: '#1a1a4a' } }
                    }
                }
            });
        }

        function renderRSIChart(timestamps, rsi) {
            if (state.charts.rsiChart) state.charts.rsiChart.destroy();
            const ctx = document.getElementById('rsiChart').getContext('2d');
            const labels = timestamps.map(t => new Date(t));

            state.charts.rsiChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{ label: 'RSI', data: rsi, borderColor: '#ffc800', borderWidth: 1.5, pointRadius: 0, fill: false }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        annotation: {
                            annotations: {
                                overbought: { type: 'line', yMin: 70, yMax: 70, borderColor: '#ff505066', borderWidth: 1, borderDash: [4, 4], label: { display: true, content: 'AÅŸÄ±rÄ± AlÄ±m (70)', position: 'end', font: { size: 9 }, color: '#ff505088', backgroundColor: 'transparent' } },
                                oversold: { type: 'line', yMin: 30, yMax: 30, borderColor: '#00e07066', borderWidth: 1, borderDash: [4, 4], label: { display: true, content: 'AÅŸÄ±rÄ± SatÄ±m (30)', position: 'end', font: { size: 9 }, color: '#00e07088', backgroundColor: 'transparent' } },
                                mid: { type: 'line', yMin: 50, yMax: 50, borderColor: '#ffffff15', borderWidth: 1, borderDash: [2, 4] }
                            }
                        },
                        tooltip: { backgroundColor: 'rgba(15,15,50,0.95)', titleColor: '#ffc800', bodyColor: '#ccc' }
                    },
                    scales: {
                        x: { type: 'time', display: false },
                        y: { min: 0, max: 100, ticks: { color: '#666', stepSize: 20 }, grid: { color: '#1a1a4a' } }
                    }
                }
            });
        }

        function renderMACDChart(timestamps, macd) {
            if (state.charts.macdChart) state.charts.macdChart.destroy();
            const ctx = document.getElementById('macdChart').getContext('2d');
            const labels = timestamps.map(t => new Date(t));
            const colors = macd.histogram.map(v => v >= 0 ? 'rgba(0,224,112,0.6)' : 'rgba(255,80,80,0.6)');

            state.charts.macdChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        { label: 'Histogram', data: macd.histogram, backgroundColor: colors, order: 2, barPercentage: 0.6 },
                        { label: 'MACD', data: macd.macd, borderColor: '#4488ff', borderWidth: 1.5, pointRadius: 0, type: 'line', fill: false, order: 1 },
                        { label: 'Sinyal', data: macd.signal, borderColor: '#ff8c00', borderWidth: 1.5, pointRadius: 0, type: 'line', fill: false, order: 1 },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#8888bb', font: { size: 10 }, usePointStyle: true } },
                        tooltip: { backgroundColor: 'rgba(15,15,50,0.95)', titleColor: '#4488ff', bodyColor: '#ccc' }
                    },
                    scales: {
                        x: { type: 'time', display: false },
                        y: { ticks: { color: '#666' }, grid: { color: '#1a1a4a' } }
                    }
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BUY/SELL SIGNAL CHART
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderSignalChart(asset, timestamps, closes, signalData) {
            if (state.charts.signalChart) state.charts.signalChart.destroy();
            const ctx = document.getElementById('signalChart').getContext('2d');
            const labels = timestamps.map(t => new Date(t));

            // Fiyat verisinin Ã¼zerinde al/sat noktalarÄ±
            const buyPoints = new Array(closes.length).fill(null);
            const sellPoints = new Array(closes.length).fill(null);

            signalData.signals.forEach(sig => {
                // En yakÄ±n timestamp'i bul
                let minDist = Infinity, minIdx = 0;
                timestamps.forEach((t, idx) => {
                    const dist = Math.abs(t - sig.t);
                    if (dist < minDist) { minDist = dist; minIdx = idx; }
                });
                if (sig.type === 'buy') buyPoints[minIdx] = closes[minIdx];
                else sellPoints[minIdx] = closes[minIdx];
            });

            state.charts.signalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Fiyat',
                            data: closes,
                            borderColor: '#8888bb',
                            backgroundColor: 'rgba(136,136,187,0.03)',
                            borderWidth: 1.5,
                            pointRadius: 0,
                            fill: true,
                            order: 3
                        },
                        {
                            label: 'ğŸŸ¢ AL Sinyali',
                            data: buyPoints,
                            borderColor: 'transparent',
                            backgroundColor: '#00e070',
                            pointRadius: 10,
                            pointHoverRadius: 14,
                            pointStyle: 'triangle',
                            showLine: false,
                            order: 1
                        },
                        {
                            label: 'ğŸ”´ SAT Sinyali',
                            data: sellPoints,
                            borderColor: 'transparent',
                            backgroundColor: '#ff5050',
                            pointRadius: 10,
                            pointHoverRadius: 14,
                            pointStyle: 'triangle',
                            pointRotation: 180,
                            showLine: false,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#8888bb', font: { size: 11 }, usePointStyle: true }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15,15,50,0.95)',
                            titleColor: '#ffd700',
                            bodyColor: '#ccc',
                            borderColor: '#333',
                            borderWidth: 1,
                            callbacks: {
                                label: function (ctx2) {
                                    if (ctx2.raw === null) return null;
                                    const label = ctx2.dataset.label;
                                    const val = fmt(ctx2.raw, asset);
                                    // Sinyal sebebini bul
                                    if (label.includes('AL') || label.includes('SAT')) {
                                        const sigType = label.includes('AL') ? 'buy' : 'sell';
                                        const sig = signalData.signals.find(s => {
                                            let minDist = Infinity, minIdx = 0;
                                            timestamps.forEach((t, idx) => { const dist = Math.abs(t - s.t); if (dist < minDist) { minDist = dist; minIdx = idx; } });
                                            return minIdx === ctx2.dataIndex && s.type === sigType;
                                        });
                                        return `${label}: ${val}${sig ? ' â€” ' + sig.reason : ''}`;
                                    }
                                    return `${label}: ${val}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: state.days <= 1 ? 'hour' : state.days <= 30 ? 'day' : state.days <= 180 ? 'week' : 'month' },
                            ticks: { color: '#666', maxTicksLimit: 12 },
                            grid: { color: '#1a1a4a' }
                        },
                        y: {
                            ticks: { color: '#666', callback: v => fmt(v, asset) },
                            grid: { color: '#1a1a4a' }
                        }
                    }
                }
            });
        }

        function renderSignalSummary(asset, signalData) {
            const d = signalData.details;
            const score = signalData.score;
            const meterPos = ((score + 100) / 200) * 100; // 0-100%

            function sigClass(val) {
                if (val.includes('GÃ¼Ã§lÃ¼ Al')) return 'buy';
                if (val.includes('Al')) return 'buy';
                if (val.includes('GÃ¼Ã§lÃ¼ Sat')) return 'sell';
                if (val.includes('Sat')) return 'sell';
                return 'neutral';
            }

            const recentSignals = signalData.signals.slice(-5).reverse();
            let recentHtml = '';
            if (recentSignals.length > 0) {
                recentHtml = '<div style="grid-column:1/-1;text-align:left;margin-top:5px">';
                recentHtml += '<div style="font-size:.75em;color:var(--dim);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px">Son Sinyaller</div>';
                recentSignals.forEach(s => {
                    const icon = s.type === 'buy' ? 'ğŸŸ¢' : 'ğŸ”´';
                    const color = s.type === 'buy' ? 'var(--green)' : 'var(--red)';
                    const date = new Date(s.t).toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                    recentHtml += `<div style="font-size:.82em;margin:3px 0;color:${color}">${icon} ${date} â€” ${fmt(s.price, asset)} â€” ${s.reason}</div>`;
                });
                recentHtml += '</div>';
            }

            document.getElementById('signalSummary').innerHTML = `
                <div class="overall-signal ${signalData.overallClass}">
                    ${signalData.overall}
                    <div style="font-size:.45em;margin-top:4px;opacity:.7">Skor: ${score > 0 ? '+' : ''}${score}/100</div>
                    <div class="signal-meter"><div class="meter-needle" style="left:${meterPos}%"></div></div>
                    <div style="display:flex;justify-content:space-between;font-size:.35em;opacity:.5"><span>GÃ¼Ã§lÃ¼ Sat</span><span>NÃ¶tr</span><span>GÃ¼Ã§lÃ¼ Al</span></div>
                </div>
                <div class="signal-item"><div class="sig-name">RSI (14)</div><div class="sig-val ${sigClass(d.rsi)}">${d.rsi}</div></div>
                <div class="signal-item"><div class="sig-name">MACD</div><div class="sig-val ${sigClass(d.macd)}">${d.macd}</div></div>
                <div class="signal-item"><div class="sig-name">SMA 20/50</div><div class="sig-val ${sigClass(d.sma)}">${d.sma}</div></div>
                <div class="signal-item"><div class="sig-name">Bollinger</div><div class="sig-val ${sigClass(d.bb)}">${d.bb}</div></div>
                <div class="signal-item"><div class="sig-name">Trend</div><div class="sig-val ${sigClass(d.trend)}">${d.trend}</div></div>
                ${recentHtml}
            `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FIBONACCI TABLE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderFibTable(asset, fib, currentPrice) {
            let html = '<table class="fib-table"><thead><tr><th>Seviye</th><th>Fiyat</th><th>Mesafe</th><th>Durum</th></tr></thead><tbody>';
            fib.forEach(f => {
                const dist = ((f.price - currentPrice) / currentPrice * 100);
                const near = Math.abs(dist) < 3;
                html += `<tr style="${near ? 'background:rgba(255,215,0,0.08)' : ''}">
            <td style="color:${f.color};font-weight:600">${f.level}</td>
            <td>${fmt(f.price, asset)}</td>
            <td style="color:${dist >= 0 ? 'var(--green)' : 'var(--red)'}">${fmtPct(dist)}</td>
            <td>${near ? '<span class="badge by">YakÄ±n</span>' : dist > 0 ? '<span class="badge bb">Ãœstte</span>' : '<span class="badge br">Altta</span>'}</td>
        </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('fibTable').innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BUY / SELL LEVELS (KÄ±sa / Orta / Uzun Vade)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let currentHorizon = 'short';

        function changeHorizon(horizon) {
            currentHorizon = horizon;
            document.querySelectorAll('.horizon-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.horizon === horizon) btn.classList.add('active');
            });
            if (state.currentLevelData) {
                const d = state.currentLevelData;
                renderBuySellLevels(d.asset, d.price, d.fib, d.supRes, d.rsi, d.bb, d.days);
            }
        }

        function getHorizonConfig(horizon) {
            switch (horizon) {
                case 'short':
                    return {
                        label: 'KÄ±sa Vade (1-7 gÃ¼n)',
                        buySpacingPct: [1.5, 3, 4.5, 6, 8],
                        sellSpacingPct: [2, 4, 6, 8, 10],
                        buyLabels: ['Scalp AlÄ±m', 'KÄ±sa AlÄ±m', 'Destek AlÄ±m', 'GÃ¼Ã§lÃ¼ AlÄ±m', 'Stop AlÄ±m'],
                        sellLabels: ['Scalp SatÄ±m', 'KÄ±sa KÃ¢r Al', 'Hedef 1', 'Hedef 2', 'Tam Ã‡Ä±kÄ±ÅŸ'],
                        buyReasons: [
                            'GÃ¼n iÃ§i destek, hÄ±zlÄ± alÄ±m fÄ±rsatÄ±',
                            'KÄ±sa vadeli destek, momentum giriÅŸi',
                            'Teknik destek bÃ¶lgesi, kÄ±sa pozisyon',
                            'Bollinger alt bandÄ± civarÄ±, gÃ¼Ã§lÃ¼ giriÅŸ',
                            'AÅŸÄ±rÄ± satÄ±m bÃ¶lgesi, riskli ama fÄ±rsat'
                        ],
                        sellReasons: [
                            'GÃ¼n iÃ§i direnÃ§, kÄ±smi kÃ¢r al',
                            'KÄ±sa vadeli direnÃ§, kÃ¢r realizasyonu',
                            'Teknik direnÃ§, pozisyon azalt',
                            'Bollinger Ã¼st band, satÄ±ÅŸ bÃ¶lgesi',
                            'AÅŸÄ±rÄ± alÄ±m, pozisyonu kapat'
                        ],
                        weights: [25, 25, 20, 18, 12]
                    };
                case 'medium':
                    return {
                        label: 'Orta Vade (1-3 ay)',
                        buySpacingPct: [3, 6, 10, 15, 20],
                        sellSpacingPct: [4, 8, 13, 18, 25],
                        buyLabels: ['Ä°lk AlÄ±m', 'Destek AlÄ±m', 'Fibonacci AlÄ±m', 'GÃ¼Ã§lÃ¼ Destek', 'Dip AlÄ±m'],
                        sellLabels: ['Hafif KÃ¢r Al', 'KÃ¢r Al', 'DirenÃ§ SatÄ±m', 'GÃ¼Ã§lÃ¼ SatÄ±m', 'Hedef SatÄ±m'],
                            buyReasons: [
                                'SMA 20 destek bÃ¶lgesi, ilk giriÅŸ',
                                'Fibonacci %23.6 destek, kademeli giriÅŸ',
                                'Fibonacci %38.2 destek, teknik alÄ±m',
                                '%50 geri Ã§ekilme, gÃ¼Ã§lÃ¼ destek',
                                'Fibonacci %61.8 destek, uzun pozisyon'
                            ],
                            sellReasons: [
                                'SMA 20 direnÃ§, kÄ±smi kÃ¢r realizasyonu',
                                'Fibonacci direnÃ§, kademeli Ã§Ä±kÄ±ÅŸ',
                                'GÃ¼Ã§lÃ¼ direnÃ§ bÃ¶lgesi, pozisyon azalt',
                                'Kritik direnÃ§, bÃ¼yÃ¼k kÄ±smÄ±nÄ± sat',
                                'Hedef fiyat, tÃ¼m pozisyonu kapat'
                            ],
                            weights: [15, 20, 25, 25, 15]
                    };
                case 'long':
                    return {
                        label: 'Uzun Vade (6 ay - 1+ yÄ±l)',
                        buySpacingPct: [5, 12, 20, 30, 40],
                        sellSpacingPct: [8, 18, 30, 45, 65],
                        buyLabels: ['Pozisyon BaÅŸlat', 'Kademeli Ekleme', 'BÃ¼yÃ¼k AlÄ±m', 'AyÄ± PiyasasÄ± AlÄ±m', 'Maksimum FÄ±rsat'],
                        sellLabels: ['KÄ±smi KÃ¢r', 'Hedef 1', 'BÃ¼yÃ¼k KÃ¢r Al', 'GÃ¼Ã§lÃ¼ SatÄ±m', 'Tam Ã‡Ä±kÄ±ÅŸ'],
                        buyReasons: [
                            'Uzun vadeli pozisyon baÅŸlangÄ±cÄ±, dÃ¼ÅŸenli alÄ±m (DCA)',
                            'SMA 200 bÃ¶lgesi, uzun vadeli destek alanÄ±',
                            'BÃ¼yÃ¼k dÃ¼zeltme, gÃ¼Ã§lÃ¼ birikim fÄ±rsatÄ±',
                            'AyÄ± piyasasÄ± dibi, agresif uzun pozisyon',
                            'Tarihsel dip bÃ¶lge, maksimum birikim'
                        ],
                        sellReasons: [
                            'Ä°lk hedef, sermayeyi koruma amacÄ±yla kÄ±smi satÄ±ÅŸ',
                            'Orta vadeli hedef, yatÄ±rÄ±mÄ±n yarÄ±sÄ±nÄ± realize et',
                            'Uzun vadeli direnÃ§, bÃ¼yÃ¼k kÃ¢r realizasyonu',
                            'BoÄŸa piyasasÄ± zirvesi, pozisyonu kÃ¼Ã§Ã¼lt',
                            'Tam hedef, tÃ¼m pozisyonu kapat ve bekle'
                        ],
                        weights: [10, 15, 25, 30, 20]
                    };
            }
        }

        function renderBuySellLevels(asset, price, fib, supRes, rsi, bb, days) {
            const config = getHorizonConfig(currentHorizon);
            const buyPoints = [];
            const sellPoints = [];

            // Fibonacci seviyeleri ile destek/direnÃ§ birleÅŸtir
            const fibBuy = fib.filter(f => f.price < price).sort((a, b) => b.price - a.price);
            const fibSell = fib.filter(f => f.price > price).sort((a, b) => a.price - b.price);

            // Generate buy levels
            for (let i = 0; i < 5; i++) {
                let targetPrice;
                // Fibonacci varsa kullan, yoksa yÃ¼zde hesapla
                if (fibBuy[i] && Math.abs((fibBuy[i].price - price) / price * 100) <= config.buySpacingPct[i] * 1.5) {
                    // Fibonacci seviyesini vade mesafesine uyarla
                    targetPrice = price * (1 - config.buySpacingPct[i] / 100);
                    // Fibonacci yakÄ±nsa fibonacci kullan
                    const fibDist = Math.abs((fibBuy[i].price - targetPrice) / targetPrice * 100);
                    if (fibDist < config.buySpacingPct[i] * 0.5) targetPrice = fibBuy[i].price;
                } else {
                    targetPrice = price * (1 - config.buySpacingPct[i] / 100);
                }
                const pct = ((targetPrice - price) / price * 100);
                const badges = ['by', 'bb', 'bg', 'bg', 'bg'];
                buyPoints.push({
                    price: targetPrice, pct,
                    badge: badges[i],
                    label: config.buyLabels[i],
                    weight: config.weights[i],
                    reason: config.buyReasons[i]
                });
            }

            // Generate sell levels
            for (let i = 0; i < 5; i++) {
                let targetPrice;
                if (fibSell[i] && Math.abs((fibSell[i].price - price) / price * 100) <= config.sellSpacingPct[i] * 1.5) {
                    targetPrice = price * (1 + config.sellSpacingPct[i] / 100);
                    const fibDist = Math.abs((fibSell[i].price - targetPrice) / targetPrice * 100);
                    if (fibDist < config.sellSpacingPct[i] * 0.5) targetPrice = fibSell[i].price;
                } else {
                    targetPrice = price * (1 + config.sellSpacingPct[i] / 100);
                }
                const pct = ((targetPrice - price) / price * 100);
                const badges = ['bo', 'br', 'br', 'bp', 'bp'];
                sellPoints.push({
                    price: targetPrice, pct,
                    badge: badges[i],
                    label: config.sellLabels[i],
                    weight: config.weights[i],
                    reason: config.sellReasons[i]
                });
            }

            // Vade etiketi
            const horizonLabel = `<div style="background:rgba(255,215,0,0.08);border:1px solid rgba(255,215,0,0.15);border-radius:8px;padding:8px 14px;margin-bottom:12px;font-size:.82em;color:var(--accent);text-align:center"><strong>â± ${config.label}</strong></div>`;

            // Render buy table
            let buyHtml = horizonLabel;
            buyHtml += '<table class="level-table"><thead><tr><th>Kademe</th><th>Fiyat</th><th>Mesafe</th><th>Pay</th><th>Seviye</th><th>AÃ§Ä±klama</th></tr></thead><tbody>';
            buyPoints.forEach((p, i) => {
                buyHtml += `<tr>
            <td><strong>${i + 1}.</strong></td>
            <td><strong>${fmt(p.price, asset)}</strong></td>
            <td style="color:var(--red)">${fmtPct(p.pct)}</td>
            <td>%${p.weight}</td>
            <td><span class="badge ${p.badge}">${p.label}</span></td>
            <td style="font-size:.82em;color:var(--dim)">${p.reason}</td>
        </tr>`;
            });
            buyHtml += '</tbody></table>';
            if (buyPoints.length > 0) {
                const avgBuy = buyPoints.reduce((s, p) => s + p.price * p.weight, 0) / 100;
                buyHtml += `<p style="margin-top:10px;font-size:.82em;color:var(--dim)">AÄŸÄ±rlÄ±klÄ± ort. giriÅŸ: <strong style="color:var(--green)">${fmt(avgBuy, asset)}</strong> (${fmtPct((avgBuy - price) / price * 100)})</p>`;
            }
            document.getElementById('buyLevels').innerHTML = buyHtml;

            // Render sell table
            let sellHtml = horizonLabel;
            sellHtml += '<table class="level-table"><thead><tr><th>Kademe</th><th>Fiyat</th><th>Mesafe</th><th>Pay</th><th>Seviye</th><th>AÃ§Ä±klama</th></tr></thead><tbody>';
            sellPoints.forEach((p, i) => {
                sellHtml += `<tr>
            <td><strong>${i + 1}.</strong></td>
            <td><strong>${fmt(p.price, asset)}</strong></td>
            <td style="color:var(--green)">${fmtPct(p.pct)}</td>
            <td>%${p.weight}</td>
            <td><span class="badge ${p.badge}">${p.label}</span></td>
            <td style="font-size:.82em;color:var(--dim)">${p.reason}</td>
        </tr>`;
            });
            sellHtml += '</tbody></table>';
            if (sellPoints.length > 0) {
                const avgSell = sellPoints.reduce((s, p) => s + p.price * p.weight, 0) / 100;
                sellHtml += `<p style="margin-top:10px;font-size:.82em;color:var(--dim)">AÄŸÄ±rlÄ±klÄ± ort. Ã§Ä±kÄ±ÅŸ: <strong style="color:var(--red)">${fmt(avgSell, asset)}</strong> (${fmtPct((avgSell - price) / price * 100)})</p>`;
            }
            document.getElementById('sellLevels').innerHTML = sellHtml;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AI ANALYSIS GENERATOR
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderAnalysis(asset, price, rsi, macd, signal, sma20, sma50, bbU, bbL, bbM, trend, fib, high, low, closes) {
            const el = document.getElementById('analysisText');
            const name = asset.name;
            const unit = asset.unit;

            // Determine overall trend
            const trendUp = trend.slope > 0;
            const trendStr = Math.abs(trend.slope) / price * 100;
            let trendText = '';
            if (trendStr > 0.5) trendText = trendUp ? 'gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ' : 'gÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸ';
            else if (trendStr > 0.1) trendText = trendUp ? 'Ä±lÄ±mlÄ± yÃ¼kseliÅŸ' : 'Ä±lÄ±mlÄ± dÃ¼ÅŸÃ¼ÅŸ';
            else trendText = 'yatay';

            // RSI analysis
            let rsiText = '';
            if (rsi < 20) rsiText = `RSI gÃ¶stergesi <strong>${rsi.toFixed(1)}</strong> ile aÅŸÄ±rÄ± satÄ±m bÃ¶lgesinde bulunmaktadÄ±r. Bu seviye genellikle gÃ¼Ã§lÃ¼ bir alÄ±m fÄ±rsatÄ± sinyali verir ve kÄ±sa vadede teknik bir toparlanma beklentisi oluÅŸturur.`;
            else if (rsi < 30) rsiText = `RSI gÃ¶stergesi <strong>${rsi.toFixed(1)}</strong> ile satÄ±m bÃ¶lgesine yaklaÅŸmÄ±ÅŸtÄ±r. FiyatÄ±n bu seviyelerden dÃ¶nÃ¼ÅŸ yapma olasÄ±lÄ±ÄŸÄ± yÃ¼ksektir, kademeli alÄ±m stratejisi deÄŸerlendirilebilir.`;
            else if (rsi > 80) rsiText = `RSI gÃ¶stergesi <strong>${rsi.toFixed(1)}</strong> ile aÅŸÄ±rÄ± alÄ±m bÃ¶lgesinin derinlerindedir. KÃ¢r realizasyonu baskÄ±sÄ± artabilir, pozisyon daraltma veya kademeli satÄ±m stratejisi uygulanabilir.`;
            else if (rsi > 70) rsiText = `RSI gÃ¶stergesi <strong>${rsi.toFixed(1)}</strong> ile aÅŸÄ±rÄ± alÄ±m bÃ¶lgesine girmiÅŸtir. KÄ±sa vadede dÃ¼zeltme riski mevcuttur, yeni pozisyon aÃ§mak yerine mevcut kÃ¢r korunmalÄ±dÄ±r.`;
            else if (rsi > 55) rsiText = `RSI gÃ¶stergesi <strong>${rsi.toFixed(1)}</strong> ile pozitif bÃ¶lgede seyretmektedir. YÃ¼kseliÅŸ momentumu devam etmekte olup, trendle uyumlu pozisyonlar sÃ¼rdÃ¼rÃ¼lebilir.`;
            else if (rsi > 45) rsiText = `RSI gÃ¶stergesi <strong>${rsi.toFixed(1)}</strong> ile nÃ¶tr bÃ¶lgededir. Piyasa kararsÄ±z gÃ¶rÃ¼nmektedir ve net bir yÃ¶n sinyali vermemektedir.`;
            else rsiText = `RSI gÃ¶stergesi <strong>${rsi.toFixed(1)}</strong> ile negatif bÃ¶lgede seyretmektedir. SatÄ±ÅŸ baskÄ±sÄ± devam etmekte olup, destek seviyelerinin takibi Ã¶nem kazanmaktadÄ±r.`;

            // MACD analysis
            let macdText = '';
            const macdDiff = macd - signal;
            if (macdDiff > 0 && macd > 0) macdText = `MACD sinyal Ã§izgisinin Ã¼zerinde ve pozitif bÃ¶lgede seyretmektedir. Bu durum yÃ¼kseliÅŸ trendinin gÃ¼Ã§lÃ¼ olduÄŸunu ve alÄ±m baskÄ±sÄ±nÄ±n sÃ¼rdÃ¼ÄŸÃ¼nÃ¼ gÃ¶stermektedir.`;
            else if (macdDiff > 0) macdText = `MACD sinyal Ã§izgisinin Ã¼zerine Ã§Ä±kmÄ±ÅŸ olup yÃ¼kseliÅŸ sinyali vermektedir. Ancak negatif bÃ¶lgede olmasÄ±, trendin henÃ¼z tam olarak dÃ¶nmediÄŸine iÅŸaret etmektedir.`;
            else if (macdDiff < 0 && macd < 0) macdText = `MACD sinyal Ã§izgisinin altÄ±nda ve negatif bÃ¶lgede seyretmektedir. DÃ¼ÅŸÃ¼ÅŸ momentumu gÃ¼Ã§lÃ¼dÃ¼r ve satÄ±ÅŸ baskÄ±sÄ± devam etmektedir.`;
            else macdText = `MACD sinyal Ã§izgisinin altÄ±na inmiÅŸ olup satÄ±ÅŸ sinyali vermektedir. Pozitif bÃ¶lgede olmasÄ± trendin tam olarak kÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± gÃ¶sterse de dikkatli olunmalÄ±dÄ±r.`;

            // Bollinger analysis
            let bbText = '';
            if (price > bbU) bbText = `Fiyat Bollinger Ã¼st bandÄ±nÄ±n Ã¼zerinde seyretmektedir. Bu, aÅŸÄ±rÄ± alÄ±m durumuna ve potansiyel geri Ã§ekilmeye iÅŸaret eder. Band dÄ±ÅŸÄ± kapanÄ±ÅŸlar genellikle sÃ¼rdÃ¼rÃ¼lebilir deÄŸildir.`;
            else if (price < bbL) bbText = `Fiyat Bollinger alt bandÄ±nÄ±n altÄ±nda seyretmektedir. Bu, aÅŸÄ±rÄ± satÄ±m durumuna ve potansiyel toparlanmaya iÅŸaret eder. FiyatÄ±n banda geri dÃ¶nme olasÄ±lÄ±ÄŸÄ± yÃ¼ksektir.`;
            else if (price > bbM) bbText = `Fiyat Bollinger orta bandÄ±nÄ±n (SMA 20) Ã¼zerinde seyretmektedir. Bu, kÄ±sa vadeli yÃ¼kseliÅŸ eÄŸiliminin devam ettiÄŸini gÃ¶stermektedir.`;
            else bbText = `Fiyat Bollinger orta bandÄ±nÄ±n (SMA 20) altÄ±nda seyretmektedir. KÄ±sa vadeli dÃ¼ÅŸÃ¼ÅŸ baskÄ±sÄ± sÃ¼rmektedir ve alt banda doÄŸru hareket riski mevcuttur.`;

            // MA analysis
            let maText = '';
            if (price > sma20 && price > sma50) maText = `Fiyat hem 20 hem de 50 periyotluk hareketli ortalamalarÄ±n Ã¼zerindedir. Bu, trendin saÄŸlÄ±klÄ± bir ÅŸekilde devam ettiÄŸini ve alÄ±cÄ±larÄ±n kontrolde olduÄŸunu gÃ¶stermektedir.`;
            else if (price > sma20) maText = `Fiyat 20 periyotluk hareketli ortalamanÄ±n Ã¼zerinde ancak 50 periyodun altÄ±ndadÄ±r. KÄ±sa vadeli toparlanma gÃ¶rÃ¼lmekle birlikte orta vadeli trend henÃ¼z dÃ¶nmemiÅŸtir.`;
            else if (price > sma50) maText = `Fiyat 50 periyotluk hareketli ortalamanÄ±n Ã¼zerinde ancak 20 periyodun altÄ±ndadÄ±r. KÄ±sa vadeli baskÄ± gÃ¶rÃ¼lmekle birlikte orta vadeli destek korunmaktadÄ±r.`;
            else maText = `Fiyat hem 20 hem de 50 periyotluk hareketli ortalamalarÄ±n altÄ±ndadÄ±r. Bu gÃ¼Ã§lÃ¼ bir dÃ¼ÅŸÃ¼ÅŸ sinyalidir ve trendin devam etme olasÄ±lÄ±ÄŸÄ± yÃ¼ksektir.`;

            // Fibonacci position
            let fibPos = '';
            const nearFib = fib.reduce((closest, f) => Math.abs(f.price - price) < Math.abs(closest.price - price) ? f : closest, fib[0]);
            fibPos = `Fiyat Fibonacci <strong>${nearFib.level}</strong> seviyesine (${fmt(nearFib.price, asset)}) yakÄ±n seyretmektedir. `;
            if (parseFloat(nearFib.level) > 50) fibPos += 'Ãœst Fibonacci bÃ¶lgesinde kalmasÄ± yÃ¼kseliÅŸ trendinin gÃ¼cÃ¼nÃ¼ koruduÄŸunu gÃ¶sterir.';
            else fibPos += 'Alt Fibonacci bÃ¶lgesinde olmasÄ± dÃ¼ÅŸÃ¼ÅŸ baskÄ±sÄ±nÄ±n sÃ¼rdÃ¼ÄŸÃ¼ne iÅŸaret eder.';

            // Overall verdict
            let score = 0;
            if (rsi < 30) score += 2; else if (rsi < 45) score += 1; else if (rsi > 70) score -= 2; else if (rsi > 55) score -= 0;
            if (macdDiff > 0) score += 1; else score -= 1;
            if (trendUp) score += 1; else score -= 1;
            if (price > sma20) score += 1; else score -= 1;
            if (price < bbL) score += 1; else if (price > bbU) score -= 1;

            let verdict, verdictClass, verdictText;
            if (score >= 3) { verdict = 'ğŸŸ¢ GÃœÃ‡LÃœ AL'; verdictClass = 'verdict-buy'; verdictText = 'Teknik gÃ¶stergelerin bÃ¼yÃ¼k Ã§oÄŸunluÄŸu alÄ±m yÃ¶nÃ¼nde sinyal vermektedir. Kademeli alÄ±m stratejisi ile pozisyon oluÅŸturulabilir.'; }
            else if (score >= 1) { verdict = 'ğŸŸ¡ AL (Dikkatli)'; verdictClass = 'verdict-buy'; verdictText = 'Teknik gÃ¶rÃ¼nÃ¼m cautiously bullish (ihtiyatlÄ± yÃ¼kseliÅŸ) yÃ¶nÃ¼ndedir. Risk yÃ¶netimi ile kademeli alÄ±m dÃ¼ÅŸÃ¼nÃ¼lebilir.'; }
            else if (score <= -3) { verdict = 'ğŸ”´ GÃœÃ‡LÃœ SAT'; verdictClass = 'verdict-sell'; verdictText = 'Teknik gÃ¶stergelerin bÃ¼yÃ¼k Ã§oÄŸunluÄŸu satÄ±ÅŸ yÃ¶nÃ¼nde sinyal vermektedir. Pozisyon daraltma veya kÃ¢r realizasyonu Ã¶nerilir.'; }
            else if (score <= -1) { verdict = 'ğŸŸ  SAT (Dikkatli)'; verdictClass = 'verdict-sell'; verdictText = 'Teknik gÃ¶rÃ¼nÃ¼m cautiously bearish (ihtiyatlÄ± dÃ¼ÅŸÃ¼ÅŸ) yÃ¶nÃ¼ndedir. Stop-loss seviyeleri sÄ±kÄ±laÅŸtÄ±rÄ±lmalÄ±dÄ±r.'; }
            else { verdict = 'ğŸŸ¡ BEKLE'; verdictClass = 'verdict-hold'; verdictText = 'Teknik gÃ¶stergeler karÄ±ÅŸÄ±k sinyal vermektedir. Net bir yÃ¶n oluÅŸana kadar beklemek veya mevcut pozisyonu korumak mantÄ±klÄ± olabilir.'; }

            // Volatility
            const returns = [];
            for (let i = 1; i < closes.length; i++) returns.push((closes[i] - closes[i - 1]) / closes[i - 1]);
            const avgReturn = returns.reduce((s, v) => s + v, 0) / returns.length;
            const volat = Math.sqrt(returns.reduce((s, v) => s + Math.pow(v - avgReturn, 2), 0) / returns.length) * 100;
            let volText = '';
            if (volat > 5) volText = `Volatilite oldukÃ§a yÃ¼ksek (%${volat.toFixed(2)}), ani fiyat hareketlerine karÅŸÄ± dikkatli olunmalÄ±dÄ±r.`;
            else if (volat > 2) volText = `Volatilite orta seviyede (%${volat.toFixed(2)}), normal piyasa koÅŸullarÄ± hakimdir.`;
            else volText = `Volatilite dÃ¼ÅŸÃ¼k (%${volat.toFixed(2)}), piyasada sakinlik hakimdir, bu durum genellikle bÃ¼yÃ¼k bir hareketin habercisi olabilir.`;

            const now = new Date();
            const dateStr = now.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            el.innerHTML = `
        <div class="analyst-text">
            <p><strong>${name}</strong> iÃ§in ${state.days} gÃ¼nlÃ¼k teknik analiz raporu (${dateStr}):</p><br>
            <p><strong>ğŸ“ˆ Trend Analizi:</strong> ${name} genel olarak <strong>${trendText}</strong> trendinde seyretmektedir. Fiyat ÅŸu anda <strong>${fmt(price, asset)}</strong> seviyesindedir. Son ${state.days} gÃ¼nde en yÃ¼ksek ${fmt(high, asset)}, en dÃ¼ÅŸÃ¼k ${fmt(low, asset)} seviyesi gÃ¶rÃ¼lmÃ¼ÅŸtÃ¼r.</p><br>
            <p><strong>ğŸ“Š Hareketli Ortalamalar:</strong> ${maText}</p><br>
            <p><strong>ğŸ“‰ RSI Analizi:</strong> ${rsiText}</p><br>
            <p><strong>ğŸ“Š MACD Analizi:</strong> ${macdText}</p><br>
            <p><strong>ğŸ“ Bollinger BantlarÄ±:</strong> ${bbText}</p><br>
            <p><strong>ğŸ”¢ Fibonacci Analizi:</strong> ${fibPos}</p><br>
            <p><strong>ğŸ“Š Volatilite:</strong> ${volText}</p><br>
            <p><strong>ğŸ“‹ SonuÃ§:</strong> ${verdictText}</p>
        </div>
        <div class="verdict ${verdictClass}">${verdict}</div>
    `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showDashboard() {
            destroyCharts();
            state.currentAsset = null;
            document.getElementById('detailView').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTO REFRESH
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let isRefreshing = false;
        let refreshCount = 0;

        async function refreshPrices() {
            if (isRefreshing) return; // prevent overlap
            isRefreshing = true;
            try {
                document.getElementById('statusDot').className = 'status-dot online';
                document.getElementById('statusText').textContent = 'ğŸ”„ GÃ¼ncelleniyor...';

                // Store old prices for comparison
                const oldPrices = JSON.parse(JSON.stringify(state.prices));

                // Fetch all in parallel
                const results = await Promise.allSettled([
                    fetchExchangeRate(),
                    fetchCryptoPrices(),
                    fetchMetalPrices()
                ]);

                // Check which succeeded (functions return true/false)
                const outcomes = results.map(r => r.status === 'fulfilled' ? r.value : false);
                const allFailed = outcomes.every(v => v === false);
                const someFailed = outcomes.some(v => v === false);

                refreshCount++;

                // Render dashboard
                renderDashboard();

                // Flash updated cards
                setTimeout(() => {
                    document.querySelectorAll('.asset-card').forEach(card => {
                        card.classList.add('flash-update');
                        setTimeout(() => card.classList.remove('flash-update'), 700);
                    });
                }, 50);

                // Update detail view if active
                if (state.currentAsset) {
                    const p = state.prices[state.currentAsset.id];
                    if (p) {
                        document.getElementById('detailPrice').textContent = fmt(p.price, state.currentAsset);
                        const chg = p.change24h || 0;
                        const chgEl = document.getElementById('detailChange');
                        chgEl.textContent = fmtPct(chg);
                        chgEl.style.color = chg >= 0 ? 'var(--green)' : 'var(--red)';
                    }
                }

                // Status feedback
                if (allFailed) {
                    document.getElementById('statusDot').className = 'status-dot offline';
                    document.getElementById('statusText').textContent = 'âŒ BaÄŸlantÄ± Yok';
                } else if (someFailed) {
                    document.getElementById('statusDot').className = 'status-dot online';
                    document.getElementById('statusText').textContent = 'âš ï¸ KÄ±smi';
                } else {
                    document.getElementById('statusDot').className = 'status-dot online';
                    document.getElementById('statusText').textContent = 'âœ… BaÄŸlÄ±';
                }

                const now = new Date();
                document.getElementById('lastUpdate').textContent = `Son: ${now.toLocaleTimeString('tr-TR')} (#${refreshCount})`;
            } catch (e) {
                console.error('Refresh error:', e);
                document.getElementById('statusDot').className = 'status-dot offline';
                document.getElementById('statusText').textContent = 'âŒ Hata: ' + e.message;
                logApi('system', false, 'Genel hata: ' + e.message);
            } finally {
                isRefreshing = false;
            }
        }

        async function manualRefresh() {
            state.countdown = 30;
            await refreshPrices();
        }

        function startCountdown() {
            state.countdown = 30;
            if (state.refreshInterval) clearInterval(state.refreshInterval);
            state.refreshInterval = setInterval(() => {
                state.countdown--;
                if (state.countdown <= 0) {
                    state.countdown = 30;
                    refreshPrices();
                }
                document.getElementById('refreshTimer').textContent = state.countdown + 's';
            }, 1000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function init() {
            logApi('system', true, 'Platform baÅŸlatÄ±lÄ±yor...');
            renderDashboard(); // Show shells immediately
            await refreshPrices();
            startCountdown();

            // Arka planda tÃ¼m varlÄ±klar iÃ§in kÄ±sa history Ã§ek (dashboard sinyalleri iÃ§in)
            logApi('system', true, 'Dashboard sinyalleri yÃ¼kleniyor...');
            const historyPromises = ASSETS.map(asset => fetchHistory(asset, 90));
            await Promise.allSettled(historyPromises);
            renderDashboard(); // Re-render with signal badges
            logApi('system', true, 'Dashboard sinyalleri hazÄ±r.');

            logApi('system', true, `BaÅŸlatÄ±ldÄ±. Protokol: ${location.protocol}`);
            if (location.protocol === 'file:') {
                logApi('system', false, 'file:// protokolÃ¼ â€” API Ã§aÄŸrÄ±larÄ± CORS nedeniyle engelleniyor! Live Server kullanÄ±n.');
                document.getElementById('corsWarning').classList.add('visible');
            }
        }

        init();
    </script>
</body>

</html>
